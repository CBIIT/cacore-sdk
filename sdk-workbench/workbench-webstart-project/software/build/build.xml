<!-- ======================================================================= -->
<!-- caCore Sdk Workbench Portal build file                                  -->
<!-- ======================================================================= -->
<project name="SDK Workbench Webstart" basedir="." default="deploy:local:install">

	<!--***********************************************************************
	*** Define the Environment Variable
	*********************************************************************** -->
	<property environment="env"/>

	<!--***********************************************************************
	*** Load the build properties for the project
	*********************************************************************** -->
	
	<property file="install.properties" />
	<property file="project.properties" />
	<property file="build.properties" />
	
	<property name="project.home" location="${basedir}/.." />
	<property name="project.build.home" location="${project.home}/build" />
	<property name="project.common.dir" location="${project.home}/common" />
	<property name="project.common.resources.dir" location="${project.common.dir}/resources" />
	
	<property name="workbench.project.dir" value="../../../workbench-project" />
	<property name="workbench.software.build.dir" location="${workbench.project.dir}/software/build" />
	<property name="workbench.dist.dir" value="${workbench.project.dir}/software/target/dist/exploded" />
	<property name="workbench.common.sdk.dist.dir" value="${workbench.project.dir}/software/common/resources/sdk-dist" />

	<import file="build-common.xml"/> 

	<!-- Default install time targets passed by deploy targets to the installer, can be overridden by being set on the command line if different target is desitred.  -->
	<property name="install.target" value="install" />
	<property name="upgrade.target" value="upgrade" />
	
	<property name="download.dir" location="${target.dir}/download" />
	<property name="dist.dir" location="${target.dir}/dist" />
	<property name="temp.dir" location="${target.dir}/temp" />
	
	<!-- Where to write files retrieved by get, into the distribution area.  The file names come from project.properties  -->
	<property name="tomcat.dest.file" value="${download.dir}/${tomcat.binaries.file}" />
	
	<property name="project.target.dir" value="${project.home}/target"/>
	<property name="lib.dir" location="${project.target.dir}/lib" />
	<property name="dist.dir" value="${project.target.dir}/dist"/>
	<property name="dist.exploded.dir" value="${dist.dir}/exploded"/>
	<property name="dist.exploded.common.dir" value="${dist.exploded.dir}/common"/>
	<property name="dist.exploded.common.sdk.dist.dir" value="${dist.exploded.common.dir}/resources/sdk-dist"/>
	
	<property name="keystore.dir" value="${dist.exploded.dir}/keystore"/>
	<property name="keystore.lib.dir" value="${keystore.dir}/lib"/>
	
	<property name="webstart.dir" value="${dist.exploded.dir}/common/resources/web"/>
	<property name="webstart.webinf.dir" value="${webstart.dir}/WEB-INF"/>
		
	<property name="download.dir" location="${target.dir}/download" />
	<property name="output.dir.location" value="${dist.exploded.dir}"/>
	<property name="output.dir" value="${output.dir.location}/output"/>
	<property name="output.war.dir" value="${dist.exploded.dir}/output/${PROJECT_NAME}/package/server/tomcat/webapps"/> 
	
	<property name="properties.file" value="install.properties"/>
	<property name="properties.file.name" value="install.properties"/>
	
	<property name="sdk.src.file" value="SDK-src.zip" />

	<!--***********************************************************************
	*** Packages the SDK Workbench into a WebStart application
	*********************************************************************** -->
	<target name="package:webstart" depends="build:workbench-modules,-copy-webstart-jars,-create-webstart-keystore,-sign-webstart-jars,-package-webstart-webapp">
		<SDKecho message="${ant.project.name}: Completed Packaging the SDK Workbench into a WebStart application"/>
	</target>

	<!--***********************************************************************
	*** Copies the Jar files required in the Workbench WebStart application
	*********************************************************************** -->
	<target name="-copy-webstart-jars">
		<delete dir="${keystore.dir}" failonerror=""/>
		<mkdir dir="${keystore.lib.dir}" />
		<copy toDir="${keystore.lib.dir}">
			<fileset dir="${workbench.dist.dir}" includes="**/*.jar" />
		</copy>
	</target>

	<!--***********************************************************************
	*** Make Workbench Workbench WebStart Application jars; required for full access
	*********************************************************************** -->
	<target name="-create-webstart-keystore">
		<SDKecho message="${ant.project.name}: Creating Workbench WebStart Keystore; Required for Signing Jars"/>
		<genkey alias="ncicb"  keystore="${keystore.dir}/workbench.jks" storepass="changeme" keypass="changeme" dname="cn=caCORE SDK Workbench,ou=caCORE SDK,o=NCICB,c=US" validity="720" verbose="true" />
	</target>

	<!--***********************************************************************
	*** Sign Workbench WebStart Application jars; required for full access
	*********************************************************************** -->
	<target name="-sign-webstart-jars">
		<SDKecho message="${ant.project.name}: Sign Workbench WebStart Application jars; required for full client system access"/>
		<signjar destDir="${keystore.lib.dir}" alias="ncicb" keystore="${keystore.dir}/workbench.jks" storepass="changeme" keypass="changeme" lazy="false">
			<path>
				<fileset dir="${keystore.lib.dir}" includes="**/*.jar" />
			</path>
		</signjar>
		<flattenmapper/>
	</target>
	
	<!--***********************************************************************
	*** Package the Workbench files into WebStart Web Application
	*********************************************************************** -->
	<target name="-package-webstart-webapp">
		<SDKecho message="${ant.project.name}: Packaging the Workbench into WebStart Web Application"/>
		<mkdir dir="${output.war.dir}" />
		<war destfile="${output.war.dir}\${workbench.webstart.war.file}" webxml="${webstart.webinf.dir}\web.xml">
			<manifest>
				<attribute name="Generated-By" value="caCORE SDK Workbench"/>
				<attribute name="Version" value="${VERSION}"/>
			</manifest>	
			<fileset dir="${keystore.dir}">
				<include name="**/*.jar"/>
			</fileset>
			<fileset dir="${webstart.dir}">
				<include name="*"/>
			</fileset>
			<fileset dir="${dist.exploded.common.sdk.dist.dir}">
				<include name="*"/>
			</fileset>
		</war>
		
	</target>
	
	<!-- Wrapper build target, calls appropriate builds for sub-projects -->
	<target name="build:all" description="Builds all the sub projects, putting artifacts in the project level target directory, used by distribution targets to make distributions" depends="
		clean,
		init,
		-copy-project-properties,
		package:webstart,
		dist:installer
		" />
	
	<target name="deploy:local:install" depends="build:workbench-modules,build:all,dist:installer:prep" description="Installs and configures the application and required binaries on the local machine. Used for developer desktops and ci environments.">
		<deploy-local target.name="${install.target}" />
	</target> 

	<target name="build:workbench-modules" description="Call workbench modules build target to produce artifacts">
		<SDKecho message="${ant.project.name}: Building the workbench source"/>
		<ant antfile="${workbench.software.build.dir}/build.xml" target="build:all" inheritall="false" inheritrefs="false"/>
	</target>
	
	<target name="build:project-webapp" depends="init" description="Call webapp sub-projects build target to produce artifiacts">
		<echo>Project Name = ${PROJECT_NAME}.........</echo>
		<ant inheritAll="true" inheritRefs="false" antfile="${codegen.build.file}" target="${codegen.build.target}" dir="${build.dir}">
		</ant>
	</target>

	<target name="build:project-webapp:dist" depends="init" description="Call webapp sub-projects build target to produce artifiacts">
		<!-- setting the property in the ant call overrides the property in the sub-project allowing the artifact to be produced where needed -->
		<ant inheritAll="true" inheritRefs="false" antfile="${codegen.build.file}" target="${package.build.target}" dir="${build.dir}">
		</ant>
	</target>

	<target name="dist:installer" depends="-copy-project-properties" description="Produces zip file based on installer distribution area. Zip is used by deploy:remote:* or external installations">
		<delete file="${dist.dir}/${project-webapp.install.zip.file}" />
		<obfuscate-properties-file properties.file="${dist.exploded.dir}/install.properties" required.property.list="application.base.path.linux,application.base.path.windows" optional.property.list="ldap.url,ldap.basedn" delete.property.list="exclude.jboss.backup" />
		<zip destfile="${dist.dir}/${project-webapp.install.zip.file}" basedir="${dist.exploded.dir}" />
	</target>
	
	<target name="dist:installer:prep" depends="dist:tools:retrieve,dist:dependent:scripts" description="Copies artifacts not generated by sub-project builds into the install distribution area">
		<echo message="* * * dist.exploded.dir: ${dist.exploded.dir}" />
		<echo message="* * * build.dir: ${build.dir}" />
		<echo message="* * * bda-utils.dir: ${bda-utils.dir}" />
		<echo message="* * * common.dir: ${common.dir}" />
		<echo message="* * * download.dir: ${download.dir}" />
		<echo message="* * * copy.tools.flag: ${copy.tools.flag}" />
		<echo message="* * * default.target: ${default.target}" />

		<dist-prep />
	</target>
	
	<target name="dist:dependent:scripts" description="target to package-system">
		<copy todir="${dist.exploded.dir}">
			<fileset dir="${basedir}" >
				<include name="*-reconfigure.xml"/>
				<include name="*-taskdef.xml"/>
				<include name="*.properties"/>
				<include name="tools/**/*"/>
			</fileset>
		</copy>
	</target>
	
	<target name="dist:tools:retrieve" description="Downloads binary applications from commonlibrary repository" depends="
		init,
		dist:tools:retrieve:tomcat
		" />
	
	<target name="-copy-project-properties">
		<copy todir="${dist.exploded.dir}" overwrite="true">
			<fileset dir="${project.build.home}" includes="*.properties" />
		</copy>
		<!-- copy common/resources folder to exploded folder -->
		<echo>Copying dir from ${project.common.resources.dir} .......</echo>
		<copy todir="${dist.exploded.dir}/common">
			<fileset dir="${project.common.dir}" />
		</copy>
		<copy todir="${dist.exploded.common.sdk.dist.dir}">
			<fileset dir="${workbench.common.sdk.dist.dir}" />
		</copy>
		<replace dir="${dist.exploded.dir}/common">
			<replacefilter token="@PROJECT_NAME@" value="${PROJECT_NAME}" />
			<replacefilter token="@SERVER_HOSTNAME@" value="${tomcat.hostname}" />
			<replacefilter token="@SERVER_PORT@" value="${tomcat.port.http}" />
			<replacefilter token="@SDK_SRC_FILE@" value="${sdk.src.file}" />
		</replace>
	</target>

	<target name="dist:tools:retrieve:tomcat" unless="tomcat.tools.exists" description="Downloads TOMCAT from binary repository and verifies checksum">
		<get src="${tomcat.src.url}" dest="${tomcat.dest.file}" />
		<get src="${tomcat.src.url}.MD5" dest="${tomcat.dest.file}.MD5" />
		<checksum file="${tomcat.dest.file}" verifyProperty="tomcat.cksum.ok" />
		<if>
			<equals arg1="${tomcat.cksum.ok}" arg2="true" />
			<then>
				<echo message="Downloaded tomcat sucessfully" />
			</then>
			<else>
				<fail message="Failed to download tomcat file sucessfully." />
			</else>
		</if>
	</target>
	
	<target name="init" description="Sets up build are and initalizes variables">
		<echo message=" ______   ______   _______ " />
		<echo message="(____  \ (______) (_______)" />
		<echo message=" ____)  ) _     _  _______ " />
		<echo message="|  __  ( | |   | ||  ___  |" />
		<echo message="| |__)  )| |__/ / | |   | |" />
		<echo message="|______/ |_____/  |_|   |_|" />
		<mkdir dir="${target.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${dist.exploded.dir}" />
		<mkdir dir="${temp.dir}" />
		<mkdir dir="${download.dir}" />

		<available file="${tomcat.dest.file}" property="tomcat.tools.exists" />
	</target>
	
	<target name="clean">
		<delete dir="${dist.dir}" failonerror="false"/>
		<delete dir="${temp.dir}" />
	</target>
	
	<macrodef name="SDKecho">
		<attribute name="message" default="..." />
		<sequential>
			<echo>*****************************************************************</echo>
			<echo>***  @{message}</echo>
			<echo>*****************************************************************</echo>
		</sequential>
	</macrodef>

</project>
